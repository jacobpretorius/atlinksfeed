<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0">
  <title>Bluesky Links - Live Stream</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }

    .description {
      display: flex;
      justify-content: end;
      margin-bottom: 2em;
    }

    .description>* {
      margin-left: 10px;
    }

    #urlList {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .url-item {
      background: white;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      animation: slideIn 0.3s ease-out;
      word-break: break-all;
    }

    .url-item a {
      color: #2962ff;
      text-decoration: none;
    }

    .url-item a:hover {
      text-decoration: underline;
    }

    @keyframes slideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
      }

      to {
        opacity: 0;
      }
    }

    .status {
      text-align: center;
      color: #666;
      margin-bottom: 20px;
    }

    .fade-out {
      animation: fadeOut 0.3s ease-out forwards;
    }
  </style>
</head>

<body>
  <h1>Bluesky Links - Live Stream</h1>
  <div class="description">
    <div class="status"
         id="status">[connecting]</div>
    <div>made by <a href="https://bsky.app/profile/jacob.earth">@jacob.earth</a></div>
  </div>
  <ul id="urlList"></ul>

  <script>
    const urlList = document.getElementById('urlList');
    const status = document.getElementById('status');
    let ws = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    const reconnectDelay = 1000;

    function connect() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}/ws`;

      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        status.textContent = '[connected]';
        reconnectAttempts = 0;
      };

      ws.onclose = () => {
        status.textContent = '[disconnected]';
        if (reconnectAttempts < maxReconnectAttempts) {
          setTimeout(() => {
            reconnectAttempts++;
            connect();
          }, reconnectDelay * Math.pow(2, reconnectAttempts));
        }
      };

      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        const li = document.createElement('li');
        li.className = 'url-item';
        li.style.display = 'flex';
        li.style.justifyContent = 'space-between';
        li.style.alignItems = 'center';
        li.innerHTML = `
          <a href="${data.link}" target="_blank" style="flex: 1">${data.link}</a>
          <a href="${data.post}" target="_blank" style="margin-left: 10px; color: #666; font-size: 0.9em;">see post â†—</a>
        `;
        urlList.insertBefore(li, urlList.firstChild);

        // Remove after 10 seconds minute
        setTimeout(() => {
          li.classList.add('fade-out');
          setTimeout(() => {
            urlList.removeChild(li);
          }, 300);
        }, 10000);
      };
    }

    connect();

    // Reconnect when the page becomes visible
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && (!ws || ws.readyState === WebSocket.CLOSED)) {
        connect();
      }
    });
  </script>
</body>

</html>